<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>–ò–° –°–±–æ—Ä–∞ –î–∞–Ω–Ω—ã—Ö by Maxim Vlasov BVT2355</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö, –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</h1>
        <p style="text-align: center; margin-top: -20px; margin-bottom: 30px; font-size: 14px;">by Maxim Vlasov BVT2355</p>
        <p>–í–≤–µ–¥–∏—Ç–µ URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —á—Ç–æ–±—ã AI –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª –µ–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏–ª –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.</p>
        
        <form id="url-form">
            <input type="url" id="url-input" placeholder="https://example.com" required>
            <button type="submit">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
        </form>

        <div id="loader" class="loader" style="display: none;"></div>
        <p id="status-text"></p>

        <div id="analysis-results" style="display: none;">
            <div id="summary-panel"></div>
            <div id="category-selection">
                <h3>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è:</h3>
                <div id="categories"></div>
                <button id="extract-button">–ò–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ</button>
            </div>
        </div>

        <div class="navigation-panel">
            {% if last_result_exists %}
            <a href="{{ url_for('show_results') }}" class="button-secondary">
                –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            </a>
            {% endif %}
        </div>

        {% if history %}
        <div class="history">
            <h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤:</h3>
            <ul>
                {% for item in history %}
                    <li>{{ item }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

    </div>

    <script>
        const urlForm = document.getElementById('url-form');
        const urlInput = document.getElementById('url-input');
        const loader = document.getElementById('loader');
        const statusText = document.getElementById('status-text');
        
        const analysisResultsDiv = document.getElementById('analysis-results');
        const summaryPanel = document.getElementById('summary-panel');
        const categoriesDiv = document.getElementById('categories');
        const extractButton = document.getElementById('extract-button');

        urlForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = urlInput.value;
            if (!url) return;

            analysisResultsDiv.style.display = 'none';
            summaryPanel.innerHTML = '';
            categoriesDiv.innerHTML = '';
            loader.style.display = 'block';
            statusText.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É... ü§ñ';

            try {
                const response = await fetch('/parse', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url: url, step: 'analyze' })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.statusText}`);
                }
                
                // –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: response.json() —É–∂–µ –ø–∞—Ä—Å–∏—Ç JSON.
                // –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º JSON.parse().
                const result = await response.json(); 

                loader.style.display = 'none';
                statusText.textContent = '';
                
                if (result.summary) {
                    displayAnalysisResults(result);
                } else {
                    statusText.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                }

            } catch (error) {
                loader.style.display = 'none';
                statusText.textContent = `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}`;
                console.error(error);
            }
        });

        function displayAnalysisResults(result) {
            summaryPanel.innerHTML = `
                <h3>–ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä —Å–∞–π—Ç–∞</h3>
                <blockquote class="summary-quote">${result.summary}</blockquote>
            `;

            if (result.available_data && result.available_data.length > 0) {
                extractButton.style.display = 'block';
                result.available_data.forEach(cat => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'category';
                    checkbox.value = cat.type;
                    label.appendChild(checkbox);
                    label.append(` ${cat.type.charAt(0).toUpperCase() + cat.type.slice(1)} (${cat.description})`);
                    categoriesDiv.appendChild(label);
                });
            } else {
                 categoriesDiv.innerHTML = "<p>–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è.</p>";
                 extractButton.style.display = 'none';
            }

            analysisResultsDiv.style.display = 'block';
        }

        extractButton.addEventListener('click', async () => {
            const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked'))
                                            .map(cb => cb.value);

            if (selectedCategories.length === 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é.');
                return;
            }
            
            loader.style.display = 'block';
            statusText.textContent = '–ò–∑–≤–ª–µ–∫–∞—é –¥–∞–Ω–Ω—ã–µ... ‚ú®';
            analysisResultsDiv.style.display = 'none';

            try {
                const response = await fetch('/parse', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        url: urlInput.value,
                        step: 'extract',
                        categories: selectedCategories
                    })
                });

                const result = await response.json();

                if (result.success) {
                    window.location.href = result.redirect_url;
                } else {
                    throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏.');
                }

            } catch (error) {
                loader.style.display = 'none';
                statusText.textContent = `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}`;
            }
        });
    </script>
</body>
</html>